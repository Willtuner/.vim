#!/usr/bin/env bash
set -e

if [[ -z $1 ]]; then
    echo "Usage: pystart [PACKAGE_FULL_PATH]"
    exit 0
fi
echo $0
SHELL_FOLDER=$(cd "$(dirname "$0")";pwd)

case $1 in
  /*) USER_INPUT=${USER_INPUT};;
  *) USER_INPUT=$PWD/$1;;
esac

ROOT_PATH=$(dirname ${USER_INPUT})

PACKAGE_NAME=$(basename ${USER_INPUT} | sed s/_/-/g)

PACKAGE=${PACKAGE_NAME//-/_}

FULL_PATH=${ROOT_PATH}/${PACKAGE_NAME}

[[ -d ${FULL_PATH} ]] && echo ${FULL_PATH} exists! && exit 2

mkdir -p ${FULL_PATH}/${PACKAGE}

echo "# -*- coding: utf-8 -*-
__version__ = \"0.0.1\"" > ${FULL_PATH}/${PACKAGE}/__init__.py

cp -r ${SHELL_FOLDER}/.pystart/ ${FULL_PATH}/

for P in '/scripts' '/etc' '/etc/supervisord.d' ''; do
    PATH=${FULL_PATH}${P}
    for F in $(/bin/ls ${PATH}); do
        [[ ! -f "${PATH}/$F" ]] && continue
        /usr/bin/sed "s/example/${PACKAGE_NAME}/g" "${PATH}/$F" | /usr/bin/tee "${PATH}/$F" >/dev/null
    done
done
